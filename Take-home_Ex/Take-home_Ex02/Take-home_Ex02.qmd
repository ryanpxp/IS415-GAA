---
title: "Take-home Exercise 02"
author: "Ryan Peh"
date: "September 25, 2024"
date-modified: "last-modified"
execute: 
  eval: true
  echo: true
  freeze: true
---

# **Take-home Exercise 2: Application of Geospatial Analysis Methods to Discover Thailand Drug Abuse at the Province Level**

## Background

Drug abuse is associated with significant negative health, financial and social consequences. Yet, illicit drug consumption remains highly prevalent and continues to be a growing problem worldwide. In 2021, 1 in 17 people aged 15â€“64 in the world had used a drug in the past 12 months. Notwithstanding population growth, the estimated number of drug users grew from 240 million in 2011 to 296 million in 2021.

The geopolitics of Thailand which is near the [Golden Triangle](https://en.wikipedia.org/wiki/Golden_Triangle_(Southeast_Asia)) of Indochina, the largest drug production site in Asia, and the constant transportation infrastructure development made Thailand became market and transit routes for drug trafficking to the third countries.

In Thailand, drug abuse is one of the major social issue. There are about 2.7 million youths using drugs in Thailand. Among youths aged between 15 and 19 years, there are about 300,000 who have needs for drug treatment. Most of Thai youths involved with drugs are vocational-school students, which nearly doubles in number compared to secondary-school students.

## **Objectives**

As a curious geospatial analytics green horn, you are interested to discover:

-   if the key indicators of drug abuse of Thailand are independent from space.

-   If the indicators of drug abuse is indeed spatial dependent, then, you would like to detect where are the clusters and outliers, and the hotspots.

-   Last but not least, you are also interested to investigate how the observation above evolve over time.

## **The Task**

The specific tasks of this take-home exercise are as follows:

-   Using appropriate function of **sf** and **tidyverse**, preparing the following geospatial data layer:

    -   a study area layer in sf polygon features. It must be at [province level](https://en.wikipedia.org/wiki/Provinces_of_Thailand) (including Bangkok) of Thailand.

    -   a drug abuse indicators layer within the study area in sf polygon features.

-   Using the extracted data, perform global spatial autocorrelation analysis by using [sfdep methods](https://is415-gaa-tskam.netlify.app/in-class_ex/in-class_ex05/in-class_ex05-glsa).

-   Using the extracted data, perform local spatial autocorrelation analysis by using [sfdep methods](https://r4gdsa.netlify.app/chap10.html).

-   Describe the spatial patterns revealed by the analysis above.

## **The Data**

For the purpose of this take-home exercise, two data sets shall be used, they are:

-   [Thailand Drug Offenses \[2017-2022\]](https://www.kaggle.com/datasets/thaweewatboy/thailand-drug-offenses-2017-2022) at Kaggle.

-   [Thailand - Subnational Administrative Boundaries](https://data.humdata.org/dataset/cod-ab-tha?) at HDX. You are required to use the province boundary data set.

## Importing Package

```{r}
pacman::p_load(sf, sfdep, tmap, tidyverse)
```

### Geospatial data
```{r}
thai <- st_read(dsn = "data/raw/Thailand_shp", 
                 layer = "tha_admbnda_adm1_rtsd_20220121")
```
### Study area

![Breakdown of Provinces of Thailand](data\raw\Thailand_provinces_en.svg.png){width=100% style="object-fit: contain;"}

```{r}
tm_shape(thai) + 
  tm_fill("ADM1_EN",
          title = "Study Area: Thailand Provinces",
          palette = "inferno") +
  tm_borders() +
  tm_layout(legend.show = FALSE)
```


### checks for holes
```{r}
u_thai <- st_union(thai)
plot(u_thai)
```

### Aspatial Data
```{r}
drugs <- read_csv("data/raw/thai_drug_offenses_2017_2022.csv")
```

## Mismatched Province

By checking on the naming of the province from both the geospatial and aspatial data, we can see that some of the namings are mismatched. This would cause problems when handling the data.

```{r}
comparison_df <- data.frame(
  Geospatial = sort(unique(thai$ADM1_EN)),
  Aspatial = sort(unique(drugs$province_en))
)

print(comparison_df)
```

The identified mismatches are:

| Geospatial | Aspatial |
|------------|----------|
| Bueng Kan  | buogkan  |
| Lop Buri   | Loburi   |

```{r}
drugs <- drugs %>%
  mutate(province_en = recode(province_en,
                              "buogkan" = "Bueng Kan",
                              "Loburi" = "Lop Buri"))

print(sort(unique(drugs$province_en)))
```

```{r}
offense_types <- c("drug_use_cases", "suspects_in_drug_use_cases")

drugs_by_year <- list()

for (year in 2017:2022) {
  drugs_by_year[[as.character(year)]] <- left_join(thai, drugs, by = c("ADM1_EN" = "province_en")) %>%
    dplyr::select(1:3, 17:19,21) %>%
    filter(fiscal_year == year, types_of_drug_offenses %in% offense_types)
}

glimpse(drugs_by_year[["2018"]])
```


```{r}
for (year in 2017:2022) {
  map <- tm_shape(drugs_by_year[[as.character(year)]]) +
    tm_fill("no_cases",
            n = 5,
            style = "equal") +  
    tm_borders(alpha = 0.5) +
    tm_layout(main.title = paste("Equal interval classification - Fiscal Year", year))
  
  print(map)
}
```
## Just 2017
```{r}
wm_q2017 <- drugs_by_year[["2017"]] %>%
  mutate(nb = st_contiguity(geometry),
         wt = st_weights(nb,
                         style = "W"),
         .before = 1)
```
## 2017 to 2022
```{r}
#| eval: false
for (year in 2017:2022) {
  wm_q <- drugs_by_year[[as.character(year)]] %>%
    mutate(nb = st_contiguity(geometry),
           wt = st_weights(nb, style = "W"),
           .before = 1)
  
  moran_results[[as.character(year)]]$weights <- wm_q
}
```

```{r}
#| eval: false
  moranI <- global_moran(moran_results[[as.character(year)]]$weights$no_cases,
                         moran_results[[as.character(year)]]$weights$nb,
                         moran_results[[as.character(year)]]$weights$wt)
  
  # Store global Moran's I results
  moran_results[[as.character(year)]]$global_moran <- moranI
}
```

```{r}
moranI2017 <- global_moran(wm_q2017$no_cases,
                       wm_q2017$nb,
                       wm_q2017$wt)
glimpse(moranI2017)
```

```{r}

set.seed(1234)
```

```{r}
global_moran_perm(wm_q2017$no_cases,
                       wm_q2017$nb,
                       wm_q2017$wt,
                  nsim = 99)
```

```{r}
lisa <- wm_q2017 %>% 
  mutate(local_moran = local_moran(
    no_cases, nb, wt, nsim = 99),
         .before = 1) %>%
  unnest(local_moran)
```

```{r}
tmap_mode("plot")
tm_shape(lisa) +
  tm_fill("ii") + 
  tm_borders(alpha = 0.5) +
  tm_view(set.zoom.limits = c(6,8)) +
  tm_layout(main.title = "local Moran's I of No of cases",
            main.title.size = 1.5)
```


```{r}

```

```{r}

```

```{r}

```

```{r}

```

```{r}

```

```{r}

```

```{r}

```

```{r}

```

```{r}

```

```{r}

```

```{r}

```

```{r}

```

```{r}

```

```{r}

```

```{r}

```

```{r}

```

```{r}

```

```{r}

```

```{r}

```

```{r}

```

```{r}

```

```{r}

```

```{r}

```

```{r}

```

```{r}

```

```{r}

```

```{r}

```

```{r}

```

```{r}

```

```{r}

```

```{r}

```

```{r}

```

```{r}

```

```{r}

```

```{r}

```

```{r}

```

```{r}

```

```{r}

```

```{r}

```

```{r}

```

```{r}

```

```{r}

```

```{r}

```

```{r}

```

```{r}

```

```{r}

```

```{r}

```

```{r}

```

```{r}

```

```{r}

```

```{r}

```

```{r}

```

```{r}

```

```{r}

```

```{r}

```

```{r}

```

```{r}

```

```{r}

```

```{r}

```

```{r}

```

```{r}

```

```{r}

```

```{r}

```
